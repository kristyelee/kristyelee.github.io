<!DOCTYPE html>
<!--
    Plain-Academic by Vasilios Mavroudis
    Released under the  Simplified BSD License/FreeBSD (2-clause) License.
    https://github.com/mavroudisv/plain-academic
-->

<html lang="en">

<head>
    <title>CS 194-26 Project 3: Kristy Lee</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"> -->
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script> -->
    <!-- <link href='https://fonts.googleapis.com/css?family=Oswald:700' rel='stylesheet' type='text/css'>-->
</head>


<body>
    <!-- Page Content -->
    <div class="container">
        <div class="row">
            <!-- Entries Column -->
            <div class="col-md-8" style="min-height: 100vh; height: auto;">
                <!-- <img class="img-responsive" src="banner.jpg" alt=""><br> -->
                <h1>CS 194-26 Project 3 Report</h1>
                <div class="col-md-4">
                    <h2><p>Kristy Lee</p></h2>
                    <p><b>kristylee@berkeley.edu</b></p>
                    <p>
                        This project involves working on code that experiments with morphing a source image into a target image. This involves defining correspondence points, finding a midway face, computing an inverse warp, and creating a morph sequence. I also examine the mean face of a population of Dane faces, and derive a caricature between my face and the mean Dane face from this.
                    </p>
                </div>
                <div style="margin-top:3%; text-align:left;">
                    <h2>Defining Correspondences</h2>
                    <p>
                        In this part of the project, I select 25 correspondence points on the source and target images. The source image is my picture, and the target image is George's picture. I take the mean of the two correspondence point sets and then produce a Delaunay triangulation over this mean set. For display purposes, I overlay this triangulation over the two images.
                    </p>
                    <table align="center">
                        <tr>
                            <td>
                                <img src="images_3/kristy_triangulation.png" alt="Kristy Triangulation"/>
                                <figcaption align="center">Mean Triangulation Applied to Kristy</figcaption> 
                            </td>
                            <td>
                                <img src="images_3/george_triangulation.png" alt="George Triangulation" />
                                <figcaption align="center">Mean Triangulation Applied to George</figcaption>
                            </td>
                        </tr>
                        <tr>                           
                            <td>
                                <img src="images_3/kristy_triangulation_points.png" alt="Triangulation Points on Kristy Image"/>
                                <figcaption align="center">Triangulation Points on Kristy Image</figcaption>
                            </td>
                            <td>
                                <img src="images_3/george_triangulation_points.png" alt="Triangulation Points on George Image"/>
                                <figcaption align="center">Triangulation Points on George Image</figcaption>
                            </td>
                        </tr>
                    </table>
                    <h2>Computing the "Mid-Way Face"</h2>
                    <p>
                        To generate the mid-way face, I compute the average shape between the source and target images by averaging the corresponding keypoints that I've computed in the above step. 
                        I then warp both images into the average shape by computing transformation matrices corresponding to inverse warps that map coordinates in the "average" image to coordinates in an original image. Let \(A\) be the inverse warp matrix. We map coordinates \((x', y')\) that will form the average image to \((x, y)\), which are coordinates in the original image using the following system of equations:
                        \[A=\begin{bmatrix} a \text{  } b \text{  } c \\ d \text{  } e \text{  } f \\ 0 \text{  } 0 \text{  } 1 \\ \end{bmatrix}\]
                        \[A \begin{bmatrix} x' \\ y' \\ 1 \\ \end{bmatrix} =  \begin{bmatrix} x \\ y \\ 1 \\ \end{bmatrix} \] 
                        To solve for \(A\) for a mapping of a particular pair of triangles between the average shape and the original image, we take triangle points from the average shape and corresponding triangle points in the original image and solve:
                        \[X' = \begin{bmatrix} x_{1}' \text{ } x_{2}' \text{ } x_{3}' \\ y_{1}' \text{ } y_{2}' \text{ } y_{3}' \\ 1 \text{ } 1 \text{ } 1 \\ \end{bmatrix}\]
                        \[X = \begin{bmatrix} x_{1} \text{ } x_{2} \text{ } x_{3} \\ y_{1} \text{ } y_{2} \text{ } y_{3} \\ 1 \text{ } 1 \text{ } 1 \\ \end{bmatrix} \]
                        \[AX' = X\]
                        \[A = XX'^{-1}\]
                        In my code, I defined <code>A = computeAffine(tri1_pts, tri2_pts)</code> to do the computation. Then, once I have the matrix A, I can map points within the average shape triangle to points corresponding in the original image. Then, I use bilinear interpolation (scipy interpolate's <code>RectBivariateSpline</code>) to obtain the colors at the source image corresponding to the warped points, and assign the color to corresponding average shape points. I do the aforementioned process of inverse warping for the original source and target images, and then take the average of the two images to get the final midway face. Here's the final result of the midway face between my face and George's face: 
                    </p>
                    <table align="center">
                        <tr>
                            <td>
                                <img src="images_3/kristylee.jpg" alt="Kristy Lee Face" style="width:240px;height:320px;"/>
                                <figcaption align="center">Kristy Original Image</figcaption> 
                            </td>
                            <td>
                                <img src="images_3/midway_face.png" alt="Midway Face" style="width:240px;height:320px;"/>
                                <figcaption align="center">Midway Face</figcaption> 
                            </td>
                            <td>
                                <img src="images_3/george_small.jpg" alt="George Face" style="width:240px;height:320px;"/>
                                <figcaption align="center">George Original Image</figcaption> 
                            </td>
                        </tr>
                    </table>

                    <h2>The Morph Sequence</h2>
                    <p>
                        I produce a morph sequence between im1=source image (Kristy) and im2=target image (George). I define <code>warp_frac</code> to weigh how much each original image's triangles contribute to the average shape and <code>dissolve_frac</code> to see how much each returned warped original image is used in cross-dissolving to the final image returned. The average shape triangle points is computed by equation \((1-\text{warp_frac}) * \text{warped_source_image} +  (\text{warp_frac}) * \text{warped_target_image}\); the cross dissolve is computed by equation \((1-\text{dissolve_frac}) * \text{warped_source_image} +  (\text{dissolve_frac}) * \text{warped_target_image}\). I define frames 0 to 45 and let <code>warp_frac = dissolve_frac</code> \(\in [0,1]\), splitting \([0,1]\) evenly between the frames. At frame 0 corresponds to the source image, and frame 45 corresponds to the target image. I create the function <code>morph(im1, im2, im1_pts, im2_pts, tri, warp_frac, dissolve_frac)</code> to generate one of the morph's images using a particular dissolve_frac=warp_frac. I call the function 46 times, once for each of the equally spaced values \(\in [0,1]\), and save all the resulting images from the morph function into a .gif that is set with fps=30. Here is the .gif I've created displaying the morph sequence:
                    </p>
                    <table align="center">
                        <tr>
                            <td>
                                <img src="images_3/morph_sequence.gif" alt="Morph Sequence" style="width:240px;height:320px;"/>
                                <figcaption align="center">Morph</figcaption> 
                            </td>
                        </tr>
                    </table>
                    <h2>The "Mean Face" of a Population</h2>
                    <p>
                        I used 33 male forward grinning faces from the Danes dataset as the population I computed the mean face from. After getting the corresponding points from the .asf files, I computed the average face shape by averaging the corresponding points and creating a triangulation of those resulting points. Then, I morphed each face of the dataset into the average shape by computing the resulting image from inverse warping. Finally, I computed the average face of the population by adding all of the morphs (of each face into the averge shape) and dividing by 33. Here's the resulting average face:
                    </p>
                    <table align="center">
                        <tr>
                            <td>
                                <img src="images_3/dane_avg_face.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane Average Face Image</figcaption> 
                            </td>
                        </tr>
                    </table>
                    Here are some examples of original Dane images, warped Dane images, and morph of the original Dane images to the mean face:
                    <table align="center">
                        <tr>
                            <td>
                                <img src="images_3/01-2m.jpg" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane 1</figcaption> 
                            </td>
                            <td>
                                <img src="images_3/morphed_dane_avg_0.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane Average Face Image</figcaption> 
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <img src="images_3/03-2m.jpg" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane 3</figcaption> 
                            </td>
                            <td>
                                <img src="images_3/morphed_dane_avg_2.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane Average Face Image</figcaption> 
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <img src="images_3/09-2m.jpg" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane 9</figcaption> 
                            </td>
                            <td>
                                <img src="images_3/morphed_dane_avg_7.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane Average Face Image</figcaption> 
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <img src="images_3/34-2m.jpg" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane 34</figcaption> 
                            </td>
                            <td>
                                <img src="images_3/morphed_dane_avg_27.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane Average Face Image</figcaption> 
                            </td>
                        </tr>
                    </table>
                    <p>Here's a video of Dane 0 warped to the average Dane image:</p>
                    <iframe align="middle" width="560" height="315" src="https://www.youtube.com/embed/4drWIGtEmrA" ></iframe>
                    <p>(Link just in case:) <a href='https://www.youtube.com/watch?v=4drWIGtEmrA'>https://www.youtube.com/watch?v=4drWIGtEmrA</a></p>
                    <p>Here are the images of my face warped to the average Dane face shape and the average Dane face warped to my face shape.</p>
                    <table align="center">
                        <tr>
                            <td>
                                <img src="images_3/me_to_dane_avg.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">Me Warped to Dane Average Shape</figcaption> 
                            </td>
                           
                        </tr>
                        <tr>
                            <td>
                                <img src="images_3/dane_avg_to_me.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">Dane Average Warped to My Shape</figcaption> 
                            </td>
                        </tr>
                    </table>

                    <h2>Caricature</h2>
                    <p>I produce a caricature of my face through extrapolating from the Dane population mean face. The formula for cross-dissolving to produce the final image from source image (my face) and target image (the Dane mean face) is \(\text{out} = (1-\alpha) * \text{source_image} + (\alpha) * \text{target_image}\). The point of extrapolation is to define \(\alpha \in (-\infty, 0) \cup (1, \infty)\) to heavily exaggerate weighting on a particular image and giving a negative weight for the other image. Here are a few examples of images (I also included the case \(\alpha=0.5\)): </p>
                    
                    <table align="center">
                        <tr>
                            <td>
                                <img src="images_3/caricature_minus03.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">\(\alpha = -0.3\)</figcaption> 
                            </td>
                           
                        </tr>
                        <tr>
                            <td>
                                <img src="images_3/caricature_minus05.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">\(\alpha = -0.5\)</figcaption> 
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <img src="images_3/caricature_minus1.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">\(\alpha = -1.0\)</figcaption> 
                            </td>
                           
                        </tr>
                        <tr>
                            <td>
                                <img src="images_3/caricature_05.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">\(\alpha = 0.5\)</figcaption> 
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <img src="images_3/caricature_15.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">\(\alpha = 1.5\)</figcaption> 
                            </td>
                           
                        </tr>
                        <tr>
                            <td>
                                <img src="images_3/caricature_2.png" style="width:320px;height:240px;"/>
                                <figcaption align="center">\(\alpha = 2.0\)</figcaption> 
                            </td>
                        </tr>
                    </table>
                    <h2>Bells and Whistles</h2>
                    <p>For Bells and Whistles, I morphed between friends and made a morphing music video. The face morphing video is also part of a morph between students in the class, too. I practiced skills of choosing corresponding points, producing triangulations/inverse warps, etc when producing the video. I used photoshop to add tint to some of the portrait images. Here is the video I created:</p>
                    <iframe align=middle" width="560" height="315" src="https://www.youtube.com/embed/pi5A0DaA8T0"></iframe>
                    <p>(The video link in case): <a href='https://www.youtube.com/watch?v=pi5A0DaA8T0'>https://www.youtube.com/watch?v=pi5A0DaA8T0</a>. Song: Bruno Mars's "Count on Me".</p>
                    <p>I also created a gif from me to a male face</p>
                    <iframe width="560" height="315" src="https://www.youtube.com/embed/NrIoi02sBas"></iframe>
                    <p>(The video link in case): <a href='https://www.youtube.com/watch?v=NrIoi02sBas'>https://www.youtube.com/watch?v=NrIoi02sBas0</a>.</p>
                    <p>I also created a music video showing age change/growing up from 5th grade me to high school me to summer 2020 me to summer 2021 me.</p>
                    <iframe width="560" height="315" src="https://www.youtube.com/embed/18ogfXSBlCI"></iframe>
                    <p>(The video link in case): <a href='https://www.youtube.com/watch?v=18ogfXSBlCI'>https://www.youtube.com/watch?v=18ogfXSBlCI</a>. Song credits to Thomas Rhett's "Growing Up".</p>

                    <h3>Summary</h3>
                    <p>
                        I learned about image morphing and transitions when producing this project. I most enjoyed learning about inverse warping and the interpolation required to get average colors in order to compute a resulting warped image, because of the matrix multiplication behind that. I also enjoyed creating a .gif for the morph sequence. 
                    </p>

                    <h3>Acknowledgements</h3>
                    <ul>
                        <li>
                            <a href="https://inst.eecs.berkeley.edu/~cs194-26/fa21/hw/proj3/">CS194-26 Project Description</a> 
                        </li>
                        <li>
                            I've obtained the Danes dataset from the instructions from the project description. <a href="https://web.archive.org/web/20210305094647/http://www2.imm.dtu.dk/~aam/datasets/datasets.html">Link</a>
                        </li>
                        <li>
                            I've obtained portraits of Shaina Chen and Anjali Thakrar for the classmate video.
                        </li>
                    </ul>
                </div>

            </div>

        </div>

    </div>

</body>


</html>
